<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe - XO Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
            padding: 20px;
        }

        .menu, .game-container, .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s ease;
            pointer-events: none;
            position: absolute;
            width: 100%;
            max-width: 500px;
        }

        .menu.active, .game-container.active, .settings-panel.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
            position: relative;
        }

        .menu h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .menu p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .menu-button, .back-button, .btn {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin: 10px 0;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .menu-button:hover, .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .menu-button.secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            padding: 10px 15px;
            font-size: 0.95rem;
        }

        .turn-indicator {
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .turn-indicator.red-turn {
            text-shadow: 0 0 20px #ff6b6b;
        }

        .turn-indicator.blue-turn {
            text-shadow: 0 0 20px #4ecdc4;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .board.red-active {
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
        }

        .board.blue-active {
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.5);
        }

        .cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cell:hover:not(.taken) {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .cell.taken {
            cursor: not-allowed;
        }

        .cell.X {
            color: var(--player1-color, #ff6b6b);
            text-shadow: 0 0 10px var(--player1-color, #ff6b6b);
            animation: popIn 0.3s ease;
        }

        .cell.O {
            color: var(--player2-color, #4ecdc4);
            text-shadow: 0 0 10px var(--player2-color, #4ecdc4);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .cell.winning {
            animation: winPulse 0.6s ease infinite;
        }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .victory-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s ease;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
        }

        .victory-message.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .victory-message.win-red {
            border: 3px solid var(--player1-color, #ff6b6b);
            box-shadow: 0 0 50px var(--player1-color, #ff6b6b);
        }

        .victory-message.win-blue {
            border: 3px solid var(--player2-color, #4ecdc4);
            box-shadow: 0 0 50px var(--player2-color, #4ecdc4);
        }

        .victory-message.draw {
            border: 3px solid #feca57;
            box-shadow: 0 0 50px #feca57;
        }

        .difficulty-selector {
            margin-bottom: 20px;
            display: none;
        }

        .difficulty-selector.show {
            display: block;
        }

        .difficulty-selector p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .difficulty-btn {
            display: inline-block;
            padding: 8px 20px;
            margin: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .difficulty-btn.selected {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border-color: #4ecdc4;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }

        .ai-thinking {
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            display: none;
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .ai-thinking.show {
            display: block;
        }

        .form-group {
            margin: 20px 0;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: white;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .color-picker {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 500px) {
            .menu h1 {
                font-size: 2rem;
            }
            .cell {
                font-size: 2.5rem;
            }
            .victory-message {
                font-size: 1.5rem;
                padding: 30px 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="menu active" id="menu">
            <h1>üéÆ Tic Tac Toe</h1>
            <p>Red (X) vs Blue (O)</p>
            <button class="menu-button" onclick="startGame('friend')">üë• Play with Friend</button>
            <button class="menu-button" onclick="startGame('ai')">ü§ñ Play with AI (Gemini)</button>
            <button class="menu-button secondary" onclick="showSettings()">‚öôÔ∏è Settings</button>
        </div>

        <div class="game-container" id="gameContainer">
            <div class="difficulty-selector" id="difficultySelector">
                <p>Select AI Difficulty:</p>
                <button class="difficulty-btn" onclick="setDifficulty('easy')">Easy</button>
                <button class="difficulty-btn selected" onclick="setDifficulty('medium')">Medium</button>
                <button class="difficulty-btn" onclick="setDifficulty('hard')">Hard</button>
            </div>

            <div class="turn-indicator" id="turnIndicator"></div>
            <div class="board" id="board"></div>

            <div class="ai-thinking" id="aiThinking">AI is thinking</div>
            <button class="back-button" onclick="backToMenu()">‚Üê Back to Menu</button>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <h2 style="color: white; margin-bottom: 20px;">‚öôÔ∏è Settings</h2>
            <div class="form-group">
                <label>Player 1 Name:</label>
                <input type="text" id="player1Name" placeholder="Player 1" value="Player 1">
            </div>
            <div class="form-group">
                <label>Player 1 Color:</label>
                <div class="color-picker" id="player1ColorPicker">
                    <div class="color-option selected" style="background: #ff6b6b;" onclick="selectColor(1, '#ff6b6b')"></div>
                    <div class="color-option" style="background: #ee5a52;" onclick="selectColor(1, '#ee5a52')"></div>
                    <div class="color-option" style="background: #ff9ff3;" onclick="selectColor(1, '#ff9ff3')"></div>
                    <div class="color-option" style="background: #feca57;" onclick="selectColor(1, '#feca57')"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Player 2 Name:</label>
                <input type="text" id="player2Name" placeholder="Player 2" value="Player 2">
            </div>
            <div class="form-group">
                <label>Player 2 Color:</label>
                <div class="color-picker" id="player2ColorPicker">
                    <div class="color-option selected" style="background: #4ecdc4;" onclick="selectColor(2, '#4ecdc4')"></div>
                    <div class="color-option" style="background: #44a08d;" onclick="selectColor(2, '#44a08d')"></div>
                    <div class="color-option" style="background: #54a0ff;" onclick="selectColor(2, '#54a0ff')"></div>
                    <div class="color-option" style="background: #48dbfb;" onclick="selectColor(2, '#48dbfb')"></div>
                </div>
            </div>
            <button class="btn" onclick="saveSettings()">Save Settings</button>
            <button class="back-button" onclick="backToMenu()">‚Üê Back</button>
        </div>

        <div class="victory-message" id="victoryMessage"></div>
    </div>

    <script>
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let gameMode = '';
        let gameActive = true;
        let isAITurn = false;
        let difficulty = 'medium';
        let settings = {
            player1: { name: 'Player 1', color: '#ff6b6b' },
            player2: { name: 'Player 2', color: '#4ecdc4' }
        };

        const menu = document.getElementById('menu');
        const gameContainer = document.getElementById('gameContainer');
        const boardElement = document.getElementById('board');
        const turnIndicator = document.getElementById('turnIndicator');
        const victoryMessage = document.getElementById('victoryMessage');
        const aiThinking = document.getElementById('aiThinking');
        const difficultySelector = document.getElementById('difficultySelector');
        const settingsPanel = document.getElementById('settingsPanel');

        const winningCombinations = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        const moveSound = new Audio('/sounds/hit.mp3');
        const winSound = new Audio('/sounds/success.mp3');
        const drawSound = new Audio('/sounds/background.mp3');

        loadSettings();

        function playSound(sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('Audio play failed:', e));
        }

        function loadSettings() {
            const saved = localStorage.getItem('tictactoe_settings');
            if (saved) {
                settings = JSON.parse(saved);
                applySettings();
            }
        }

        function applySettings() {
            document.documentElement.style.setProperty('--player1-color', settings.player1.color);
            document.documentElement.style.setProperty('--player2-color', settings.player2.color);
        }

        function showSettings() {
            showPanel(settingsPanel);
            document.getElementById('player1Name').value = settings.player1.name;
            document.getElementById('player2Name').value = settings.player2.name;

            document.querySelectorAll('#player1ColorPicker .color-option').forEach(opt => {
                opt.classList.toggle('selected', opt.style.background === `rgb(${hexToRgb(settings.player1.color)})`);
            });
            document.querySelectorAll('#player2ColorPicker .color-option').forEach(opt => {
                opt.classList.toggle('selected', opt.style.background === `rgb(${hexToRgb(settings.player2.color)})`);
            });
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function selectColor(player, color) {
            const picker = player === 1 ? 'player1ColorPicker' : 'player2ColorPicker';
            document.querySelectorAll(`#${picker} .color-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');

            if (player === 1) {
                settings.player1.color = color;
            } else {
                settings.player2.color = color;
            }
        }

        function saveSettings() {
            settings.player1.name = document.getElementById('player1Name').value || 'Player 1';
            settings.player2.name = document.getElementById('player2Name').value || 'Player 2';
            localStorage.setItem('tictactoe_settings', JSON.stringify(settings));
            applySettings();
            backToMenu();
        }

        function showPanel(panel) {
            [menu, gameContainer, settingsPanel].forEach(p => {
                p.classList.remove('active');
            });
            panel.classList.add('active');
        }

        function startGame(mode) {
            gameMode = mode;
            board = ['', '', '', '', '', '', '', '', ''];
            gameActive = true;
            isAITurn = false;
            currentPlayer = Math.random() < 0.5 ? 'X' : 'O';

            difficultySelector.classList.toggle('show', mode === 'ai');
            renderBoard();
            updateTurnIndicator();
            showPanel(gameContainer);

            if (mode === 'ai' && currentPlayer === 'X') {
                setTimeout(() => makeAIMove(), 500);
            }
        }

        function setDifficulty(level) {
            difficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function renderBoard() {
            boardElement.innerHTML = '';
            board.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'cell';
                if (cell) {
                    cellElement.textContent = cell;
                    cellElement.classList.add('taken', cell);
                }
                cellElement.addEventListener('click', () => handleCellClick(index));
                boardElement.appendChild(cellElement);
            });

            boardElement.classList.remove('red-active', 'blue-active');
            if (gameActive) {
                boardElement.classList.add(currentPlayer === 'X' ? 'red-active' : 'blue-active');
            }
        }

        function handleCellClick(index) {
            if (!gameActive || board[index] !== '' || isAITurn) return;

            makeMove(index);
        }

        function makeMove(index) {
            board[index] = currentPlayer;
            playSound(moveSound);
            renderBoard();

            const winner = checkWinner();
            if (winner) {
                endGame(winner);
            } else if (board.every(cell => cell !== '')) {
                endGame('draw');
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                updateTurnIndicator();

                if (gameMode === 'ai' && currentPlayer === 'X') {
                    setTimeout(() => makeAIMove(), 300);
                }
            }
        }

        function updateTurnIndicator() {
            const playerName = currentPlayer === 'X' ? settings.player1.name : settings.player2.name;
            const playerSymbol = currentPlayer;
            turnIndicator.textContent = `${playerName}'s Turn (${playerSymbol})`;
            turnIndicator.className = 'turn-indicator ' + (currentPlayer === 'X' ? 'red-turn' : 'blue-turn');
        }

        async function makeAIMove() {
            if (!gameActive) return;

            isAITurn = true;
            aiThinking.classList.add('show');

            try {
                const response = await fetch('/api/ai-move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ board, difficulty })
                });

                const data = await response.json();

                setTimeout(() => {
                    aiThinking.classList.remove('show');
                    if (data.move !== undefined && board[data.move] === '') {
                        makeMove(data.move);
                    }
                    isAITurn = false;
                }, 500);
            } catch (error) {
                console.error('AI move error:', error);
                aiThinking.classList.remove('show');
                isAITurn = false;
            }
        }

        function checkWinner() {
            for (const combo of winningCombinations) {
                const [a, b, c] = combo;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    highlightWinningCells([a, b, c]);
                    return board[a];
                }
            }
            return null;
        }

        function highlightWinningCells(cells) {
            const cellElements = boardElement.querySelectorAll('.cell');
            cells.forEach(index => {
                cellElements[index].classList.add('winning');
            });
        }

        function endGame(result) {
            gameActive = false;
            boardElement.classList.remove('red-active', 'blue-active');

            let message = '';
            let messageClass = '';

            if (result === 'draw') {
                message = "It's a Draw! ü§ù";
                messageClass = 'draw';
                playSound(drawSound);
            } else {
                const winnerName = result === 'X' ? settings.player1.name : settings.player2.name;
                message = `${winnerName} Wins! üéâ`;
                messageClass = result === 'X' ? 'win-red' : 'win-blue';
                playSound(winSound);
            }

            victoryMessage.textContent = message;
            victoryMessage.className = `victory-message show ${messageClass}`;

            setTimeout(() => {
                victoryMessage.classList.remove('show');
                setTimeout(backToMenu, 300);
            }, 3000);
        }

        function backToMenu() {
            [gameContainer, settingsPanel].forEach(p => {
                p.classList.remove('active');
            });
            menu.classList.add('active');
        }
    </script>
</body>
</html>
